<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Editor vigilante (rich)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { font-family: system-ui, Arial, sans-serif; }
    body { margin: 0; background:#f7f7fb; }
    header, footer { background:#111; color:#fff; padding:12px 16px; }
    main { max-width: 980px; margin: 18px auto; padding: 0 16px; }
    .panel { background:#fff; border:1px solid #e6e6ee; border-radius:12px; padding:16px; box-shadow: 0 2px 8px rgba(0,0,0,.05); }
    .fila { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .row { margin:12px 0; }
    button, input[type=color], select {
      cursor:pointer; border:none; border-radius:10px; padding:9px 12px; background:#eaeaf3; color:#111;
    }
    button.btn { background:#6b7cff; color:#fff; }
    button.btn.sec { background:#e6e6ee; color:#111; }
    #toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    #editor {
      border:1px solid #d9d9e3; border-radius:10px; min-height:50vh; padding:14px 16px; background:#fff; line-height:1.5;
      outline:none;
    }
    #editor:focus { border-color:#6b7cff; box-shadow:0 0 0 3px rgba(107,124,255,.2); }
    .status { margin-top:10px; font-size:.95rem; color:#333; }
    .warn  { color:#b10000; font-weight:600; }
    .ok    { color:#0a7a34; font-weight:600; }
    .muted { color:#666; font-size:.9rem; }
    .contador { font-weight:700; }
  </style>
</head>
<body>
  <header>
    <strong>Editor vigilante</strong> ‚Äî formato + anti-copypaste + foco vigilado üïµÔ∏è
  </header>

  <main>
    <div class="panel">
      <div class="row">
        <div class="fila">
          <button id="btnStart" class="btn">Iniciar (pantalla completa)</button>
          <button id="btnFinish" class="btn sec">Finalizar y descargar .doc</button>
          <span class="muted">Se monitorea el foco y se bloquea copiar/pegar/atajos comunes.</span>
        </div>
      </div>

      <div id="toolbar" class="row" aria-label="Barra de formato">
        <button type="button" title="Negrita" data-cmd="bold"><b>N</b></button>
        <button type="button" title="Subrayado" data-cmd="underline"><u>S</u></button>
        <input type="color" id="colorPicker" title="Color de texto" />
        <button type="button" title="Resaltar" id="btnHighlight">üñç Resaltar</button>
        <button type="button" title="Quitar formato" id="btnClear">üßπ Limpiar</button>
        <!-- Extras opcionales
        <button type="button" data-cmd="italic"><i>I</i></button>
        <button type="button" data-cmd="justifyLeft">‚ü∏</button>
        <button type="button" data-cmd="justifyCenter">‚áî</button>
        <button type="button" data-cmd="justifyRight">‚üπ</button>
        -->
      </div>

      <div id="editor" contenteditable="true" role="textbox" aria-multiline="true">
        Escrib√≠ aqu√≠ tu texto con formato‚Ä¶
      </div>

      <div class="row status">
        <div>Infracciones de foco/visibilidad: <span id="infCount" class="contador">0</span> (l√≠mite: <span id="infLimit">3</span>)</div>
        <div id="msg" class="muted">Consejo: manten√© la pesta√±a visible y en pantalla completa.</div>
      </div>
    </div>
  </main>

  <footer>
    <span class="muted">Nota: no se puede impedir 100% minimizar/Alt+Tab. Esto lo detecta y act√∫a en consecuencia.</span>
  </footer>

  <script>
    // ===== Configuraci√≥n =====
    const INF_LIMIT = 3;            // cu√°ntas ‚Äúsalidas‚Äù permit√≠s antes de bloquear
    const BLOCK_PRINT = true;       // Ctrl+P
    const BLOCK_DEVTOOLS = true;    // F12 / Ctrl+Shift+I
    const BLOCK_NEW_TABS = true;    // Ctrl+T/N/W
    const BLOCK_SAVE = true;        // Ctrl+S
    const WARN_TEXT = "Acci√≥n no permitida.";
    const FOCUS_WARN = "No abandones la pesta√±a ni salgas de pantalla completa.";

    // ===== Referencias DOM =====
    const editor   = document.getElementById('editor');
    const btnStart = document.getElementById('btnStart');
    const btnFinish= document.getElementById('btnFinish');
    const msg      = document.getElementById('msg');
    const infCount = document.getElementById('infCount');
    const infLimit = document.getElementById('infLimit');
    const colorPicker = document.getElementById('colorPicker');
    const btnHighlight = document.getElementById('btnHighlight');
    const btnClear = document.getElementById('btnClear');
    infLimit.textContent = INF_LIMIT;

    let infractions = 0;
    let locked = false;

    function setMessage(text, type="") {
      msg.textContent = text;
      msg.className = type ? `status ${type}` : 'status';
    }

    // ===== Pantalla completa =====
    async function goFullscreen() {
      try {
        if (!document.fullscreenElement) {
          await document.documentElement.requestFullscreen();
        }
        setMessage("Pantalla completa activada. ¬°A escribir! ‚úçÔ∏è", "ok");
        editor.focus();
      } catch (e) {
        setMessage("No se pudo activar pantalla completa. Permit√≠ la acci√≥n en el navegador.", "warn");
      }
    }
    function exitFullscreen() {
      if (document.fullscreenElement) document.exitFullscreen();
    }

    // ===== Bloqueos de copiar/pegar/men√∫/contexto (permitimos selecci√≥n para dar formato) =====
    function blockClipboardAndContext(el) {
      const block = e => { e.preventDefault(); setMessage(WARN_TEXT, "warn"); };
      ['copy','cut','paste','contextmenu','dragstart','drop'].forEach(ev => {
        el.addEventListener(ev, block);
      });
    }
    blockClipboardAndContext(editor);
    document.addEventListener('contextmenu', e => e.preventDefault());

    // ===== Atajos de teclado comunes a bloquear =====
    document.addEventListener('keydown', e => {
      const ctrl = e.ctrlKey || e.metaKey;
      const shift = e.shiftKey;
      const key = e.key.toLowerCase();

      // Copiar/pegar/cortar/seleccionar todo/abrir nueva pesta√±a/ventana/cerrar
      if (ctrl && ['c','v','x','a','s','p','u','t','n','w'].includes(key)) {
        if (key==='s' && !BLOCK_SAVE) return;
        if (key==='p' && !BLOCK_PRINT) return;
        if (['t','n','w'].includes(key) && !BLOCK_NEW_TABS) return;
        e.preventDefault(); setMessage(WARN_TEXT, "warn");
      }
      // F12, Ctrl+Shift+I (DevTools)
      if ((e.key === 'F12' && BLOCK_DEVTOOLS) || (ctrl && shift && key==='i' && BLOCK_DEVTOOLS)) {
        e.preventDefault(); setMessage(WARN_TEXT, "warn");
      }
    });

    // ===== Detecci√≥n de p√©rdida de foco / visibilidad =====
    function registerInfraction(reason) {
      if (locked) return;
      infractions++;
      infCount.textContent = infractions;
      setMessage(`${FOCUS_WARN} (Motivo: ${reason}). Intento ${infractions}/${INF_LIMIT}`, "warn");
      if (infractions >= INF_LIMIT) {
        locked = true;
        editor.setAttribute('contenteditable', 'false');
        editor.blur();
        setMessage("Se alcanz√≥ el l√≠mite de infracciones. Edici√≥n bloqueada. Descarg√° lo que tengas.", "warn");
      }
    }
    window.addEventListener('blur', () => registerInfraction('blur de ventana'));
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState !== 'visible') registerInfraction('pesta√±a oculta');
    });
    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement) registerInfraction('salida de pantalla completa');
    });

    // ===== Antes de salir (algunos navegadores lo ignoran) =====
    window.addEventListener('beforeunload', (e) => {
      e.preventDefault();
      e.returnValue = '';
    });

    // ===== Barra de formato =====
    // Botones simples basados en execCommand (funciona bien para este caso escolar)
    document.getElementById('toolbar').addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-cmd]');
      if (!btn) return;
      const cmd = btn.getAttribute('data-cmd');
      document.execCommand(cmd, false, null);
      editor.focus();
    });
    // Color de fuente
    colorPicker.addEventListener('change', () => {
      document.execCommand('foreColor', false, colorPicker.value);
      editor.focus();
    });
    // Resaltar (background color)
    btnHighlight.addEventListener('click', () => {
      document.execCommand('hiliteColor', false, '#ffff00');
      editor.focus();
    });
    // Limpiar formato
    btnClear.addEventListener('click', () => {
      document.execCommand('removeFormat', false, null);
      editor.focus();
    });

    // ===== Botones principales =====
    btnStart.addEventListener('click', goFullscreen);

    btnFinish.addEventListener('click', () => {
      // Salimos de pantalla completa por si acaso
      exitFullscreen();

      // Tomamos el HTML interno y lo empacamos en un HTML compatible con Word
      const contenido = editor.innerHTML;
      const htmlDoc = `
        <html xmlns:o='urn:schemas-microsoft-com:office:office'
              xmlns:w='urn:schemas-microsoft-com:office:word'
              xmlns='http://www.w3.org/TR/REC-html40'>
        <head><meta charset='utf-8'>
          <style>
            body { font-family: Arial, sans-serif; }
            p { margin: 0 0 .6em 0; }
          </style>
        </head>
        <body>${contenido}</body></html>`;

      const blob = new Blob(['\ufeff', htmlDoc], { type: 'application/msword' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'entrega.doc';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      setMessage("Documento .doc descargado. ‚úÖ", "ok");
    });
  </script>
</body>
</html>
